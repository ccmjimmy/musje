<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: model/model.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: model/model.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global musje */

(function (musje) {
  'use strict';

  // Constants and helpers
  // =================================================================

  var
    A4_FREQUENCY = 440,
    A4_MIDI_NUMBER = 69,
    TEMPO = 80,
    STEP_TO_MIDI_NUMBER = [null, 0, 2, 4, 5, 7, 9, 11],
    ACCIDENTAL_TO_ALTER = { '#' : 1, '##': 2, n: 0, b : -1, bb: -2 },
    TYPE_TO_STRING = {
      1: ' - - - ', 2: ' - ', 4: '', 8: '_', 16: '=', 32: '=_',
      64: '==', 128: '==_', 256: '===', 512: '===_', 1024: '===='
    },
    // Convert from duration type to number of underbars.
    TYPE_TO_UNDERBAR = {
      1: 0, 2: 0, 4: 0, 8: 1, 16: 2, 32: 3,
      64: 4, 128: 5, 256: 6, 512: 7, 1024: 8
    },
    DOT_TO_STRING = { 0: '', 1: '.', 2: '..' },
    BAR_TO_STRING = {
      single: '|', double: '||', end: '|]',
      'repeat-begin': '|:', 'repeat-end': ':|', 'repeat-both': ':|:'
    };

  function chars(ch, num) {
    return new Array(num + 1).join(ch);
  }

  function octaveString(octave) {
    return octave > 0 ? chars('\'', octave) :
           octave &lt; 0 ? chars(',', -octave) : '';
  }

  function getAlter(pitch) {
    var
      note = pitch.note,
      step = pitch.step,
      data = note.cell.data,
      datum,
      i;

    for (i = note.index - 1; i >= 0; i--) {
      datum = data[i];
      if (datum.$name === 'Note' &amp;&amp;
          datum.pitch.step === step &amp;&amp; datum.pitch.accidental) {
        // note.alterLink = datum;
        return datum.pitch.alter;
      }
    }
    return 0;
  }

  // Musje model definitions
  // =================================================================
  musje.model = {
    title: 'Musje',
    description: '123 jianpu music score',

    // Root object
    // ---------------------------------------------------------------
    root: {
      /**
       * @class
       * @alias musje.Score
       * @param {Object} score - plain score object {@link musje.PlainScore}.
       */
      Score:
      /** @lends musje.Score.prototype */
      {
        /**
         * Head of the score.
         * @type {musje.ScoreHead}
         */
        head: { $ref: '#/objects/ScoreHead' },
        /**
         * Partwise parts.
         * @type {musje.PartwiseParts}
         */
        parts: { $ref: '#/arrays/PartwiseParts' },

        /**
         * Timewise measures, generated by the initialize function.
         * @type {musje.TimewiseMeasures}
         */
        measures: { $ref: '#/arrays/TimewiseMeasures' },

        toString: function () {
          return this.head + this.parts.map(function (part) {
            return part.toString();
          }).join('\n\n');
        }
      }
    },

    // Integers
    // ---------------------------------------------------------------
    integers: {
      beatType: {
        enum: [1, 2, 4, 8, 16, 32, 64, 128, 256, 512],
        default: 4
      }
    },

    // Objects
    // ---------------------------------------------------------------
    objects:
    /** @lends musje */
    {
      /**
       * @class
       * @param head {Object}
       * @property title {string} Title of the song.
       * @property composer {string} Composer of the song.
       */
      ScoreHead: {
        title: { type: 'string' },
        composer: { type: 'string' },
        isEmpty: function () {
          return !this.title &amp;&amp; !this.composer;
        },
        toString: function () {
          return '&lt;&lt;' + this.title + '>>' + this.composer + '\n';
        }
      },

      /**
       * @class
       * @param part {Object}
       * @property measures {musje.Cells}
       */
      PartwisePart: {
        // head: { $ref: '#/objects/PartHead' },
        measures: { $ref: '#/arrays/Cells' },
        toString: function () {
          return this.measures.map(function (cell) {
            return cell;
          }).join(' ');
        }
      },

      /**
       * @class
       * @param measure {Object}
       * @property parts {musje.Cells}
       */
      TimewiseMeasure: {
        parts: { $ref: '#/arrays/Cells' }
      },

      /**
       * @class
       * @param cell {Object}
       * @property data {musje.MusicData}
       */
      Cell:
      /** @lends musje.Cell.prototype */
      {
        /**
         * Music data
         * @type {Array.&lt;musje.MusicData>}
         */
        data: { $ref: '#/arrays/MusicData' },

        /**
         * @return {string}
         */
        toString: function () {
          return this.data.map(function (musicData) {
            return musicData.toString();
          }).join(' ');
        }
      },

      // partHead: TO BE DEFINED!,

      /**
       * @class
       * @param pitch {Object}
       */
      Pitch:
      /** @lends musje.Pitch.prototype */
      {
        /**
         * Step is a value of `1`, `2`, `3`, `4`, `5`, `6`, or `7`.
         * @type {number}
         */
        step: {
          type: 'integer',
          minimum: 1,
          maximum: 7,
          default: 1
        },

        /**
         * Octave is an integer value from `-5` to `5` inclusive.
         * @type {number}
         */
        octave: {
          type: 'integer',
          minimum: -5,
          maximum: 5,
          default: 0
        },

        /**
         * Accidental is either of
         * - `'#'` - sharp
         * - `'##'` - double sharp
         * - `'b'` - flat
         * - `'bb'` - double flat
         * - `'n'` - natural
         * - `''` - (none)
         * @type {string}
         */
        accidental: {
          type: 'string',
          enum: ['#', 'b', '', 'n', '##', 'bb'],
          default: ''
        },
        alter: {
          get: function () {
            var acc = this.accidental;
            return acc ? ACCIDENTAL_TO_ALTER[acc] : getAlter(this);
          }
        },
        midiNumber: {
          get: function () {
            return (this.octave + 5) * 12 +
              STEP_TO_MIDI_NUMBER[this.step] + this.alter;
          }
        },
        frequency: {
          get: function () {
            return A4_FREQUENCY * Math.pow(2, (this.midiNumber - A4_MIDI_NUMBER) / 12);
          }
        },

        /**
         * @return {string}
         */
        toString: function () {
          return this.accidental + this.step + octaveString(this.octave);
        }
      },

      /**
       * @class
       * @param duration {Object}
       */
      Duration:
      /** @lends musje.Duration.prototype */
      {
        /**
         * Beat type
         * @type {number}
         */
        type: { $ref: '#/integers/beatType' },

        /**
         * Dot with value of 0, 1, or 2.
         * @type {number}
         */
        dot: {
          type: 'integer',
          minimum: 0,
          maximum: 2,
          default: 0
        },

        /**
         * Tie
         * @type {boolean}
         */
        tie: {
          type: 'boolean',
          default: false
        },

        /**
         * `(Getter)` Duration measured in quarter note.
         * @type {number}
         */
        quarter: {
          get: function () {
            var d = 4 / this.type;
            return this.dot === 0 ? d :
                   this.dot === 1 ? d * 1.5 : d * 1.75;
          }
        },

        /**
         * `(Getter)` Duration in second
         * Affected by the tempo.
         * @type {number}
         */
        second: {
          get: function () {
            return this.quarter * 60 / TEMPO;
          }
        },

        /**
         * `(Getter)` Underbar
         * @type {number}
         */
        underbar: {
          get: function () {
            return TYPE_TO_UNDERBAR[this.type] || 0;
          }
        },

        /**
         * @return {string}
         */
        toString: function () {
          return TYPE_TO_STRING[this.type] + DOT_TO_STRING[this.dot];
        }
      }
    },

    // Elements are use inside an array
    // ---------------------------------------------------------------
    elements:
    /** @lends musje */
    {
      /**
       * Time signature.
       * @class
       * @param time {Object}
       */
      Time:
      /** @lends musje.Time.prototype */
      {
        /** @member {number} */
        beats: {
          type: 'integer',
          default: 4
        },

        /**
         * Beat type
         * @member {number}
         */
        beatType: { $ref: '#/integers/beatType' },
        toString: function () {
          return this.beats + '/' + this.beatType;
        }
      },

      /**
       * @class
       * @param {Object} note
       */
      Note:
      /** @lends musje.Note.prototype */
      {
        /**
         * @member {musje.Pitch}
         */
        pitch: { $ref: '#/objects/Pitch' },

        /** @member {musje.Duration} */
        duration: { $ref: '#/objects/Duration' },

        /** @member {musje.Slurs} */
        slurs: { $ref: '#/arrays/Slurs' },

        /** @method */
        initialize: function () {
          this.pitch.note = this;
        },

        /** @method */
        toString: function () {
          return this.pitch + this.duration;
        }
      },

      /**
       * @class
       * @param {rest} rest
       */
      Rest:
      /** @lends musje.Rest.prototype */
      {
        /** @member {musje.Duration} */
        duration: { $ref: '#/objects/Duration' },

        /** @method */
        toString: function () {
          return '0' + this.duration;
        }
      },

      /**
       * @class
       * @param {Object} chord
       */
      Chord:
      /** @lends musje.Chord.prototype */
      {
        /** @member {Array.&lt;musje.Pitch>} */
        pitches: {
          type: 'array',
          items: { $ref: '#/objects/Pitch' }
        },

        /** @member {musje.Duration} */
        duration: { $ref: '#/objects/Duration' },

        /** @method */
        toString: function () {
          return '&lt;' + this.pitches.map(function (pitch) {
            return pitch.toString();
          }).join('') + '>' + this.duration;
        }
      },

      // Voice: {
      //   type: 'array',
      //   items: {
      //     oneOf: [
      //       { $ref: '#/elements/Note' },
      //       { $ref: '#/elements/Rest' },
      //       { $ref: '#/elements/Chord' },
      //     ]
      //   }
      // }

      /**
       * @class
       * @param {string} bar - The bar value, which can be either of
       * `'single'`, `'double'`, `'end'`, `'repeat-begin'`, `'repeat-end'`, or `'repeat-both'`.
       */
      Bar:
      /** @lends musje.Bar.prototype */
      {
        /**
         * @member {string} - The bar value
         * @alias musje.Bar.prototype.value
         */
        type: 'string',
        enum: [
          'single', 'double', 'end',
          'repeat-begin', 'repeat-end', 'repeat-both'
        ],

        default: 'single',

        /** @method */
        toString: function () {
          return BAR_TO_STRING[this.value];
        }
      }
    },

    // Arrays
    // ---------------------------------------------------------------
    arrays: {
      PartwiseParts: { $ref: '#/objects/PartwisePart' },
      TimewiseMeasures: { $ref: '#/objects/TimewiseMeasure' },
      Cells: { $ref: '#/objects/Cell' },
      MusicData: [
        { $ref: '#/elements/Time' },
        { $ref: '#/elements/Note' },
        { $ref: '#/elements/Rest' },
        { $ref: '#/elements/Chord' },
        // { $ref: '#/elements/Voice' },
        { $ref: '#/elements/Bar' }
      ],
      Slurs: {
        type: 'string',
        enum: ['begin', 'end']
      }
    }
  };

  musje.makeClasses(musje, musje.model);

  /**
   * Wrapper function to creat a {@link musje.Score} instance.
   * ### Usage:
   * ```js
   * var score = musje.score(JSONString or object);
   * ```
   * @param score {string|Object} JSONString or plain object.
   * @return {musje.Score} - A musje.Score instance.
   */
  musje.score = function (obj) {
    if (typeof obj === 'string') { obj = JSON.parse(obj); }
    return new musje.Score(obj);
  };

}(musje));
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="musje.Bar.html">Bar</a></li><li><a href="musje.Cell.html">Cell</a></li><li><a href="musje.Cell-Beam.html">Beam</a></li><li><a href="musje.Chord.html">Chord</a></li><li><a href="musje.Duration.html">Duration</a></li><li><a href="musje.Layout.html">Layout</a></li><li><a href="musje.Layout.Body.html">Body</a></li><li><a href="musje.Layout.Svg.html">Svg</a></li><li><a href="musje.Note.html">Note</a></li><li><a href="musje.PartwisePart.html">PartwisePart</a></li><li><a href="musje.Pitch.html">Pitch</a></li><li><a href="musje.Rest.html">Rest</a></li><li><a href="musje.Score.html">Score</a></li><li><a href="musje.ScoreHead.html">ScoreHead</a></li><li><a href="musje.Time.html">Time</a></li><li><a href="musje.TimewiseMeasure.html">TimewiseMeasure</a></li></ul><h3>Namespaces</h3><ul><li><a href="musje.html">musje</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Sat Aug 29 2015 17:05:54 GMT+0800 (台北標準時間)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
